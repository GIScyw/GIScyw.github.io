---
title: npm包链接调试技巧
date: 2024-09-11
tags:
  - Code
---

- 使用 npm link 或者 pnpm link， 应该依据的是使用的项目是那种包管理的，而不是根据 library 的包管理而定的。我们可以在 npm 项目中使用 pnpm link 将包链接到全局，这个对包管理器没有限制。
- 在 library 项目下，执行  `npm link`  命令，把 library 项目添加到全局的 node_modules 文件夹下，建立一个软链接。

npm/pnpm link 的问题

- npm install 在安装依赖的时候，会合并相同依赖，安装在最外层的 node_modules 中。所以只有一份依赖。而 npm link 是直接引用本地目录，本地目录的 node_modules 会和主项目的 node_modules 同时存在两份相同的引用。对于 Npm link 方式，**「因为 Npm 和 项目属于不同的项目，它们有自己的 node_modules」**,如果组件和应用都使用了同一个依赖，它们会在各自的 node_modules 去查找，如果这个依赖不支持多例，应用就会异常。如果 npm 的编译规则 和应用的编译规则不匹配，也同样会出问题。 常见的问题如[解决 npm link 本地代码后 react 库存在多份实例的问题 - 掘金](https://juejin.cn/post/6922687641485836301)
  但是 yalc 就不会有这种问题了，yalc 将组件的包依赖提升至应用中，在全局添加组件依赖，在应用下新建文件拉取依赖，即使有共同的依赖也会从应用的 node_modules 去查找。**「使用 yalc 可以避免上面 npm link 的依赖问题」**
  以上问题即，yalc 会将包依赖提升至应用中，而 npm link 是将包依赖放到全局的 nodemodules 里面，所以这就导致 yalc 是可以找到应用的 nodemodules，而 npm 就找不到 nodemodules 了，肯定会存在多份实例的

yalc 的优势

1. 能触发 hmr
2. 主库 node_modules 下原本的包会被缓存，在移除后可以还原

yalc 的工作流程：
`yalc`  在本地环境中创建了一个共享的本地开发包的本地存储库。 当在指定包目录中运行  `yalc publish`时，会将本来发布到 NPM 上的相关文件放到本地一个共享的全局存储中。 当在需要引用的项目中运行  `yalc add my-package`  时，它会将包内容拉入根目录的的 .yalc 文件夹中，并将一个文件  `"file:.yalc/my-package"`  注入  `package.json`。如果使用  `yalc link my-package`  的话，就类似  `npm | yarn link`  一样创建项目链接，不会修改  `package.json`。 yalc 会在项目中创建一个特殊的  `yalc.lock`  文件（类似于 yarn.lock 和 package-lock.json），用于确保执行 yalc 例程时的一致性。

> yalc publish 发布后的，应用里面 yalc add 到的东西是跟 npm publish 一样的， 是没有 nodemodules，因为 yalc 是直接存储到了应用里面，所以他会找到应用的 nodemodules 里面的包，我们在调试的时候，如果有些包时 npm 包里面依赖的，但是应用里面没有安装与使用的， 那就要再手动 install 了，这种情况也是挺多的

yalc 调试全流程：
library: 直接 npm run watch, 然后有更改后直接保存自动触发 nodemon。这里需要注意 yalc publish 加上--sig，这个对前端项目 HMR 生效很重要
main project：除了首次 yalc add 之后，完全不需要其他命令了，连 yalc update 都不需要

注意：pnpm 项目也是可以支持的 直接进入对应的子包，然后 yalc publish; 或者执行 yalc publish packages/subpack1, 相关：https://github.com/wclr/yalc#publishpush-sub-projects

yalc + nodemon

```js
"async": "npm run build && yalc push --sig",

"watch": "nodemon --ignore dist/ --ignore node_modules/ --watch src/ -C -e ts,tsx,scss --debug -x 'npm run async'"
```

[wclr/yalc: Work with yarn/npm packages locally like a boss.](https://github.com/wclr/yalc)

[居然有比 npm link 更好的调试？](https://mp.weixin.qq.com/s/I4hhrgI3-Y18HD8zw_9g9w)
[wclr/yalc: Work with yarn/npm packages locally like a boss.](https://github.com/wclr/yalc/issues/195)
[你所不知道的模块调试技巧 - npm link · Issue #17 · atian25/blog](https://github.com/atian25/blog/issues/17)
